(()=>{"use strict";var e,t={"./assets/js/mail_notification.js":(e,t,s)=>{var n=s("./node_modules/vue/dist/vue.common.prod.js"),i=s.n(n),o=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("div",{},[s("app-menu",{attrs:{"menu-info":e.menuInfo}}),e._v(" "),s("b-container",{},[s("b-row",[s("b-nav",{attrs:{tabs:""}},[s("b-nav-item",{attrs:{active:"",href:"/mail_notification/"}},[e._v("\n                    Envoyer un email\n                ")]),e._v(" "),s("b-nav-item",{attrs:{href:"/mail_notification/list/"}},[e._v("\n                    Liste des emails envoyés\n                ")]),e._v(" "),s("b-nav-item",{attrs:{href:"/mail_answer/"}},[e._v("\n                    Gestion des modèles\n                ")]),e._v(" "),s("b-nav-item",{attrs:{href:"/core/members/"}},[e._v("\n                    Gestion des personnes\n                ")])],1)],1),e._v(" "),s("b-row",[s("b-form",{on:{submit:e.onSubmit}},[s("div",[s("b-form-group",{attrs:{label:"Choisissez d'abord l'enseignement : "}},[s("b-form-radio-group",{attrs:{name:"teaching"},model:{value:e.teaching,callback:function(t){e.teaching=t},expression:"teaching"}},[s("b-form-radio",{attrs:{value:"secondaire"}},[e._v("\n                                Secondaire\n                            ")]),e._v(" "),s("b-form-radio",{attrs:{value:"primaire"}},[e._v("\n                                Primaire\n                            ")])],1)],1)],1),e._v(" "),e.teaching?s("div",[s("h3",[e._v("Enseignement : "+e._s(e.teaching.toUpperCase()))]),e._v(" "),s("b-form-group",{attrs:{label:"Le type de destinataires : "}},[s("b-form-radio-group",{attrs:{name:"toType"},on:{change:e.warnChoice},model:{value:e.toType,callback:function(t){e.toType=t},expression:"toType"}},[s("b-form-radio",{attrs:{value:"teachers"}},[e._v("\n                                Professeurs\n                            ")]),e._v(" "),s("b-form-radio",{attrs:{value:"parents"}},[e._v("\n                                Parents\n                            ")])],1)],1),e._v(" "),"parents"==e.toType?s("b-form-group",{attrs:{description:"Si «Par parent» est choisi, un parent ayant plusieurs enfants ne recevra qu'un seul email. À contrario, si «Par élève» est choisi, un parent ayant plusieurs élèves recevra un email par élève.",label:"Type d'envoi : "}},[s("b-form-radio-group",{attrs:{name:"sendType"},model:{value:e.sendType,callback:function(t){e.sendType=t},expression:"sendType"}},[s("b-form-radio",{attrs:{value:"parents"}},[e._v("\n                                Par parent\n                            ")]),e._v(" "),s("b-form-radio",{attrs:{value:"students"}},[e._v("\n                                Par élève\n                            ")])],1)],1):e._e(),e._v(" "),s("b-form-group",{attrs:{description:"Sélectionner à partir de quelle adresse l'email sera envoyé.",label:"Expéditeur* : ",state:e.emailFromState}},[s("multiselect",{attrs:{options:e.emailFromOptions,placeholder:"Sélectionner un expéditeur","select-label":"Cliquer dessus pour sélectionner","selected-label":"Sélectionné","deselect-label":"Cliquer dessus pour enlever"},model:{value:e.emailFrom,callback:function(t){e.emailFrom=t},expression:"emailFrom"}},[s("span",{attrs:{slot:"noResult"},slot:"noResult"},[e._v("Aucun expéditeur trouvé.")]),e._v(" "),s("span",{attrs:{slot:"noOptions"},slot:"noOptions"})]),e._v(" "),s("b-alert",{attrs:{variant:"danger",show:!e.emailFromState}},[e._v("\n                            Merci de choisir un expéditeur.\n                        ")])],1),e._v(" "),s("b-form-group",{attrs:{description:"Ajouter un cycle et/ou un degré, une année, une classe…",label:"Destinataires* : ",state:e.emailToState}},[s("multiselect",{attrs:{"internal-search":!1,options:e.emailToOptions,multiple:!0,loading:e.emailToLoading,placeholder:"Ajouter un destinataire","select-label":"Cliquer dessus pour sélectionner","selected-label":"Sélectionné","deselect-label":"Cliquer dessus pour enlever"},on:{"search-change":e.getEmailToOptions},model:{value:e.emailTo,callback:function(t){e.emailTo=t},expression:"emailTo"}},[s("span",{attrs:{slot:"noResult"},slot:"noResult"},[e._v("Aucun destinataire trouvé.")]),e._v(" "),s("span",{attrs:{slot:"noOptions"},slot:"noOptions"})]),e._v(" "),s("b-alert",{attrs:{variant:"danger",show:!e.emailToState}},[e._v("\n                            Merci de choisir au moins un destinataire.\n                        ")])],1),e._v(" "),s("b-form-group",[s("b-form-checkbox",{model:{value:e.responsibles,callback:function(t){e.responsibles=t},expression:"responsibles"}},[e._v("\n                            Également envoyer aux educateurs et coordonnateurs correspondants.\n                        ")])],1),e._v(" "),"students"==e.sendType?s("b-form-group",[s("multiselect",{attrs:{options:e.templateOptions,"track-by":"id",label:"name",placeholder:"Ajouter un formulaire à remplir"},model:{value:e.template,callback:function(t){e.template=t},expression:"template"}},[s("span",{attrs:{slot:"noOptions"},slot:"noOptions"})])],1):e._e(),e._v(" "),s("b-form-group",{attrs:{label:"Tag(s) : ",description:"Permet de facilement identifier l'email (CPE, CGQ,…)"}},[s("multiselect",{attrs:{"internal-search":!1,options:e.tagsOptions,multiple:!0,loading:e.tagsLoading,placeholder:"Ajouter un tag si besoin.","select-label":"Cliquer dessus pour sélectionner","selected-label":"Sélectionné","deselect-label":"Cliquer dessus pour enlever"},on:{"search-change":e.getTagsOptions},model:{value:e.tags,callback:function(t){e.tags=t},expression:"tags"}},[s("span",{attrs:{slot:"noResult"},slot:"noResult"},[e._v("Aucun tag trouvé.")]),e._v(" "),s("span",{attrs:{slot:"noOptions"},slot:"noOptions"})])],1),e._v(" "),s("b-form-group",{attrs:{label:"Sujet* : "}},[s("b-form-input",{attrs:{type:"text",placeholder:"Sujet de l'email"},model:{value:e.subject,callback:function(t){e.subject=t},expression:"subject"}})],1),e._v(" "),s("b-form-group",{attrs:{description:"Ajouter une ou des pièces jointes à l'email. Accepte uniquement des fichiers pdf.",label:"Pièce(s) jointe(s) : "}},[s("b-form-file",{ref:"attachments",attrs:{multiple:"",accept:".pdf",placeholder:"Attacher un ou des fichiers.","choose-label":"Attacher un ou des fichiers","drop-label":"Déposer des fichiers ici",plain:""},on:{input:e.addFiles},model:{value:e.attachments,callback:function(t){e.attachments=t},expression:"attachments"}}),e._v(" "),e._l(e.uploadedFiles,(function(t,n){return s("b-list-group",{key:n},[s("file-upload",{attrs:{id:t.id,file:t.file,path:"/mail_notification/upload_file/"},on:{delete:function(t){return e.deleteFile(n)},setdata:function(t){return e.setFileData(n,t)}}})],1)}))],2),e._v(" "),s("b-form-group",{attrs:{description:e.explanation_mail,label:"Email : "}},[s("quill-editor",{attrs:{content:e.emailContent,options:e.editorOptions},on:{change:function(t){return e.onEditorChange(t)}}}),e._v(" "),s("div",{staticClass:"html ql-editor",domProps:{innerHTML:e._s(e.replaceContent())}})],1),e._v(" "),s("b-button",{attrs:{type:"submit",variant:"primary"}},[e._v("\n                        Envoyer\n                    ")])],1):e._e()])],1)],1),e._v(" "),s("b-modal",{attrs:{centered:""},model:{value:e.showModal,callback:function(t){e.showModal=t},expression:"showModal"}},[e.sending?s("p",[s("icon",{attrs:{name:"refresh",scale:"1",spin:""}}),e._v(" Envoi des emails en cours…\n        ")],1):e._e(),e._v(" "),e.sending||e.hasError?e._e():s("p",[e._v("\n            La demande d'envoi des emails a été soumise !\n        ")]),s("p"),!e.sending&&e.hasError?s("p",[e._v("\n            Désolé, une erreur est survenue lors de l'envoi du mail. Merci de réessayer plus tard ou de contacter un administrateur.\n        ")]):e._e(),s("p"),s("div",{staticClass:"w-100",attrs:{slot:"modal-footer"},slot:"modal-footer"},[s("b-btn",{staticClass:"float-right",attrs:{size:"sm",variant:"primary"},on:{click:function(t){e.showModal=!1}}},[e._v("\n                OK\n            ")])],1)])],1)};o._withStripped=!0;var a=s("./node_modules/bootstrap-vue/esm/index.js"),l=s("./node_modules/vue-quill-editor/dist/vue-quill-editor.js"),r=(s("./node_modules/quill/dist/quill.core.css"),s("./node_modules/quill/dist/quill.snow.css"),s("./node_modules/quill/dist/quill.js")),u=s.n(r),d=(s("./node_modules/bootstrap-vue/dist/bootstrap-vue.css"),s("./node_modules/vue-multiselect/dist/vue-multiselect.min.css"),s("./node_modules/vue-awesome/icons/index.js"),s("./node_modules/vue-awesome/components/Icon.vue")),c=s("./node_modules/axios/index.js"),m=s.n(c),p=s("./node_modules/vue-multiselect/dist/vue-multiselect.min.js"),h=s.n(p),v=s("./assets/common/file_upload.vue"),f=s("./assets/common/menu.vue");i().use(a.ZPm);var b=u().import("blots/block");b.tagName="DIV",u().register(b,!0),i().use(a.ZPm),i().component("icon",d.Z);const _={data:function(){return{menuInfo:{},explanation_mail:"",toType:"teachers",subject:"",emailTo:[],emailToOptions:[],emailToLoading:!1,emailToState:!0,emailFrom:"",emailFromOptions:[],emailFromState:!0,emailContent:"",sendType:"parents",template:null,templateOptions:[],tags:[],tagsOptions:[],tagsLoading:!1,teaching:null,responsibles:!1,attachments:[],uploadedFiles:[],showModal:!1,sending:!1,hasError:!1,editorOptions:{modules:{toolbar:[["bold","italic","underline","strike"],["blockquote"],["link","image"],[{header:1},{header:2}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],[{font:[]}],[{align:[]}],["clean"]]},placeholder:"Ecrivez le mail ici."},preshow:""}},watch:{teaching:function(){var e=this;this.teaching&&(this.emailFrom="",this.responsibles=!1,m().get("/mail_notification/get_senders/"+this.teaching+"/").then((function(t){e.emailFromOptions=t.data.map((function(e){return e.sender_email_name+" <"+e.sender_email+">"}))})))}},methods:{warnChoice:function(){"teachers"===this.toType&&alert("Vous avez choisi d'envoyer aux parents.")},reset:function(){this.toType="teachers",this.subject="",this.emailFrom="",this.emailTo=[],this.tags=[],this.emailContent="",this.preshow="",this.$refs.attachments.reset(),this.uploadedFiles.splice(0,this.uploadedFiles.length),this.teaching=null,this.hasError=!1,this.responsibles=!0},addFiles:function(){for(var e in this.attachments)this.uploadedFiles.push({file:this.attachments[e],id:-1});this.attachments.splice(0,this.attachments.length)},setFileData:function(e,t){this.uploadedFiles[e].id=t.id,this.uploadedFiles[e].link=t.attachment},deleteFile:function(e){this.uploadedFiles.splice(e,1),this.$refs.attachments.reset()},replaceContent:function(){var e="<ul>";for(var t in this.attachments)e+='<li><a href="#" >'.concat(this.attachments[t].name,"</a></li>\n");return e+="</ul>",this.emailContent.replace(/\{\{ nom \}\}/g,"Toto Tutu").replace(/\{\{ classe \}\}/g,"3B").replace(/\{\{ fichiers \}\}/g,e)},getEmailToOptions:function(e){var t=this;this.emailToLoading=!0,m().get("/mail_notification/get_email_to_options/"+this.teaching+"/"+this.toType+"/?query="+e).then((function(e){t.emailToOptions=e.data,t.emailToLoading=!1}))},getTagsOptions:function(e){var t=this;this.tagsLoading=!0,m().get("/mail_notification/get_tags_options/?query="+e).then((function(e){t.tagsOptions=e.data,t.tagsLoading=!1}))},onEditorChange:function(e){this.emailContent=e.html},onSubmit:function(e){if(e.preventDefault(),this.emailFrom?this.emailFromState=!0:this.emailFromState=!1,0==this.emailTo.length?this.emailToState=!1:this.emailToState=!0,0!==this.emailTo.length&&this.emailFrom){this.sending=!0,this.showModal=!0;var t=new FormData;t.append("to_type",this.toType),t.append("email_to",this.emailTo),t.append("responsibles",this.responsibles),t.append("email_from",this.emailFrom),t.append("send_type",this.sendType),t.append("email_content",this.emailContent),t.append("subject",this.subject),t.append("teaching",this.teaching),this.template&&t.append("template",this.template.id);var s=[];for(var n in this.uploadedFiles)s.push(this.uploadedFiles[n].id);t.append("attachments",s);var i=this;m().post("send_emails/",t,{xsrfCookieName:"csrftoken",xsrfHeaderName:"X-CSRFToken"}).then((function(){i.sending=!1,i.reset()})).catch((function(){i.sending=!1,i.hasError=!0}))}}},components:{Multiselect:h(),quillEditor:l.quillEditor,FileUpload:v.Z,AppMenu:f.Z},mounted:function(){var e=this;this.menuInfo=menu,this.getTagsOptions(""),m().get("/mail_answer/api/mail_template/?is_used=0").then((function(t){e.templateOptions=t.data.results})).catch((function(e){alert(e)}))}};var g=s("./node_modules/style-loader/dist/runtime/injectStylesIntoStyleTag.js"),y=s.n(g),T=s("./node_modules/css-loader/dist/cjs.js!./node_modules/vue-loader/lib/loaders/stylePostLoader.js!./node_modules/vue-loader/lib/index.js??vue-loader-options!./assets/mail_notification/mail_notification.vue?vue&type=style&index=0&lang=css&");y()(T.Z,{insert:"head",singleton:!1}),T.Z.locals;var j=(0,s("./node_modules/vue-loader/lib/runtime/componentNormalizer.js").Z)(_,o,[],!1,null,null,null);j.options.__file="assets/mail_notification/mail_notification.vue";const O=j.exports;new(i())({el:"#vue-app",template:"<mail-notification/>",components:{MailNotification:O}})},"./node_modules/css-loader/dist/cjs.js!./node_modules/vue-loader/lib/loaders/stylePostLoader.js!./node_modules/vue-loader/lib/index.js??vue-loader-options!./assets/mail_notification/mail_notification.vue?vue&type=style&index=0&lang=css&":(e,t,s)=>{s.d(t,{Z:()=>o});var n=s("./node_modules/css-loader/dist/runtime/api.js"),i=s.n(n)()((function(e){return e[1]}));i.push([e.id,'\n.html {\n  height: 9em;\n  overflow-y: auto;\n  border: 1px solid #ccc;\n  border-top: none;\n  resize: vertical;\n}\n.custom-file-label::after {\n    content: "Parcourir";\n}\n[v-cloak] {\n  display: none;\n}\n',""]);const o=i}},s={};function n(e){var i=s[e];if(void 0!==i)return i.exports;var o=s[e]={id:e,loaded:!1,exports:{}};return t[e].call(o.exports,o,o.exports,n),o.loaded=!0,o.exports}n.m=t,e=[],n.O=(t,s,i,o)=>{if(!s){var a=1/0;for(u=0;u<e.length;u++){for(var[s,i,o]=e[u],l=!0,r=0;r<s.length;r++)(!1&o||a>=o)&&Object.keys(n.O).every((e=>n.O[e](s[r])))?s.splice(r--,1):(l=!1,o<a&&(a=o));l&&(e.splice(u--,1),t=i())}return t}o=o||0;for(var u=e.length;u>0&&e[u-1][2]>o;u--)e[u]=e[u-1];e[u]=[s,i,o]},n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var s in t)n.o(t,s)&&!n.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),n.j=162,(()=>{var e={162:0};n.O.j=t=>0===e[t];var t=(t,s)=>{var i,o,[a,l,r]=s,u=0;for(i in l)n.o(l,i)&&(n.m[i]=l[i]);if(r)var d=r(n);for(t&&t(s);u<a.length;u++)o=a[u],n.o(e,o)&&e[o]&&e[o][0](),e[a[u]]=0;return n.O(d)},s=self.webpackChunkhappyschool=self.webpackChunkhappyschool||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})();var i=n.O(void 0,[351],(()=>n("./assets/js/mail_notification.js")));i=n.O(i)})();